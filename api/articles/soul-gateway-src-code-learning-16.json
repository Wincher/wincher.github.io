{"title":"soul_gateway_src_code_learning_16","slug":"soul-gateway-src-code-learning-16","date":"2021-02-01T15:50:07.000Z","updated":"2021-02-01T16:50:13.917Z","comments":true,"excerpt":"","content":"<p>Hystrix plugin 分析</p>\n<p>这是一段对Hystrix的介绍, 目前该项目已经不再开发, 只有维护</p>\n<blockquote>\n<p> Hystrix is a latency and fault tolerance library designed to isolate points of access to remote systems, services and 3rd party libraries, stop cascading failure and enable resilience in complex distributed systems where failure is inevitable.</p>\n<p>Hystrix是一个延迟和容错库，旨在隔离对远程系统，服务和第三方库的访问点，停止级联故障，并在不可避免发生故障的复杂分布式系统中实现弹性。</p>\n</blockquote>\n<p>一切正常, 启动bootstrap中加入引用</p>\n\n    <pre><code class=\"lang-xml\"><span class=\"xml\"> <span class=\"hljs-comment\">&lt;!-- soul hystrix plugin start--&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span>\n      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.dromara<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span>\n      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>soul-spring-boot-starter-plugin-hystrix<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span>\n       <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>$</span><span class=\"hljs-template-variable\">{last.version}</span><span class=\"xml\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span>\n  <span class=\"hljs-comment\">&lt;!-- soul hystrix plugin end--&gt;</span>\n</span></code></pre>\n<p>并在管理页面开启  hystrix,为开启, 并配置规则</p>\n<ul>\n<li>跳闸最小请求数量: 少达到这个最小请求书才会触发熔断</li>\n<li>错误百分比阀值: 一段短时间内错误响应打到百分比会熔断</li>\n<li>跳闸休眠时间: 熔断后恢复时间</li>\n<li>分组Key: 一般为:contextPath,默认为divide的selector名</li>\n<li>命令Key: 一般为具体的路径接口,默认为divide规则名</li>\n<li>失败降级URL: 降级调用的的url</li>\n</ul>\n<p>HystrixPlugin 核心逻辑</p>\n\n    <pre><code class=\"lang-java\"><span class=\"hljs-keyword\">protected</span> Mono&lt;Void&gt; doExecute(<span class=\"hljs-keyword\">final</span> ServerWebExchange exchange, <span class=\"hljs-keyword\">final</span> SoulPluginChain chain, <span class=\"hljs-keyword\">final</span> SelectorData selector, <span class=\"hljs-keyword\">final</span> RuleData rule) {\n        <span class=\"hljs-keyword\">final</span> SoulContext soulContext = exchange.getAttribute(Constants.CONTEXT);\n        <span class=\"hljs-keyword\">assert</span> soulContext != <span class=\"hljs-literal\">null</span>;\n        <span class=\"hljs-comment\">// 获取熔断配置</span>\n        <span class=\"hljs-keyword\">final</span> HystrixHandle hystrixHandle = GsonUtils.getInstance().fromJson(rule.getHandle(), HystrixHandle.<span class=\"hljs-keyword\">class</span>);\n        <span class=\"hljs-keyword\">if</span> (StringUtils.isBlank(hystrixHandle.getGroupKey())) {\n            hystrixHandle.setGroupKey(Objects.requireNonNull(soulContext).getModule());\n        }\n        <span class=\"hljs-keyword\">if</span> (StringUtils.isBlank(hystrixHandle.getCommandKey())) {\n            hystrixHandle.setCommandKey(Objects.requireNonNull(soulContext).getMethod());\n        }\n        Command command = fetchCommand(hystrixHandle, exchange, chain);\n        <span class=\"hljs-keyword\">return</span> Mono.create(s -&gt; {\n            Subscription sub = command.fetchObservable().subscribe(<span class=\"hljs-string\">s:</span>:success,\n<span class=\"hljs-symbol\">                    s:</span>:error, <span class=\"hljs-string\">s:</span>:success);\n            s.onCancel(<span class=\"hljs-string\">sub:</span>:unsubscribe);\n            <span class=\"hljs-comment\">// 断路器 判断是否熔断</span>\n            <span class=\"hljs-keyword\">if</span> (command.isCircuitBreakerOpen()) {\n                log.error(<span class=\"hljs-string\">\"hystrix execute have circuitBreaker is Open! groupKey:{},commandKey:{}\"</span>, hystrixHandle.getGroupKey(), hystrixHandle.getCommandKey());\n            }\n        }).doOnError(throwable -&gt; {\n            log.error(<span class=\"hljs-string\">\"hystrix execute exception:\"</span>, throwable);\n            exchange.getAttributes().put(Constants.CLIENT_RESPONSE_RESULT_TYPE, ResultEnum.ERROR.getName());\n            chain.execute(exchange);\n        }).then();\n    }\n</code></pre>\n\n    <pre><code class=\"lang-java\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-function\">Command <span class=\"hljs-title\">fetchCommand</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">final</span> HystrixHandle hystrixHandle, <span class=\"hljs-keyword\">final</span> ServerWebExchange exchange, <span class=\"hljs-keyword\">final</span> SoulPluginChain chain)</span> </span>{\n        <span class=\"hljs-keyword\">if</span> (hystrixHandle.getExecutionIsolationStrategy() == HystrixIsolationModeEnum.SEMAPHORE.getCode()) {\n            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> HystrixCommand(HystrixBuilder.build(hystrixHandle),\n                exchange, chain, hystrixHandle.getCallBackUri());\n        }\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> HystrixCommandOnThread(HystrixBuilder.buildForHystrixCommand(hystrixHandle),\n            exchange, chain, hystrixHandle.getCallBackUri());\n    }\n</code></pre>\n<p>TODO: 分析fetchCommand具体实现逻辑</p>\n","categories":[],"tags":[{"name":"SOUL","path":"api/tags/SOUL.json"}]}