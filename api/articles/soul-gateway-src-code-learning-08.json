{"title":"soul_gateway_src_code_learning_08","slug":"soul-gateway-src-code-learning-08","date":"2021-01-22T16:13:04.000Z","updated":"2021-01-24T17:24:24.074Z","comments":true,"excerpt":"","content":"<h3 id=\"SOUL-Admin-amp-网关-Http长轮询-数据同步\"><a href=\"#SOUL-Admin-amp-网关-Http长轮询-数据同步\" class=\"headerlink\" title=\"SOUL Admin &amp; 网关 Http长轮询 数据同步\"></a>SOUL Admin &amp; 网关 Http长轮询 数据同步</h3><p>书接上回, 使用Http长轮询, 数据同步,</p>\n<p>soul-admin/src/main/resources/application.yml</p>\n\n    <pre><code class=\"lang-yaml\">soul:\n  sync:\n<span class=\"hljs-meta\">#</span><span class=\"bash\">    websocket:</span>\n<span class=\"hljs-meta\">#</span><span class=\"bash\">      enabled: <span class=\"hljs-literal\">true</span></span>\n<span class=\"hljs-meta\">#</span><span class=\"bash\">    zookeeper:</span>\n<span class=\"hljs-meta\">#</span><span class=\"bash\">        url: localhost:2181</span>\n<span class=\"hljs-meta\">#</span><span class=\"bash\">        sessionTimeout: 5000</span>\n<span class=\"hljs-meta\">#</span><span class=\"bash\">        connectionTimeout: 2000</span>\n      http:\n        enabled: true\n</code></pre>\n<p>soul-bootstrap/src/main/resources/application-local.yml, 同理</p>\n\n    <pre><code class=\"lang-yaml\"><span class=\"hljs-attribute\">soul </span>:\n    <span class=\"hljs-attribute\">sync</span>:\n#        <span class=\"hljs-attribute\">websocket </span>:\n#             <span class=\"hljs-attribute\">urls</span>: <span class=\"hljs-attribute\">ws</span>:<span class=\"hljs-comment\">//localhost:9095/websocket</span>\n#        <span class=\"hljs-attribute\">zookeeper</span>:\n#             <span class=\"hljs-attribute\">url</span>: <span class=\"hljs-attribute\">localhost</span>:<span class=\"hljs-number\">2181</span>\n#             <span class=\"hljs-attribute\">sessionTimeout</span>: <span class=\"hljs-number\">5000</span>\n#             <span class=\"hljs-attribute\">connectionTimeout</span>: <span class=\"hljs-number\">2000</span>\n        <span class=\"hljs-attribute\">http</span>:\n             <span class=\"hljs-attribute\">url </span>: <span class=\"hljs-attribute\">http</span>:<span class=\"hljs-comment\">//localhost:9095</span>\n</code></pre>\n<p>soul-bootstrap/pom.xml  已经添加了</p>\n\n    <pre><code class=\"lang-xml\"><span class=\"xml\"><span class=\"hljs-comment\">&lt;!--soul data sync start use http--&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.dromara<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>soul-spring-boot-starter-sync-data-http<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>$</span><span class=\"hljs-template-variable\">{project.version}</span><span class=\"xml\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span>\n</span></code></pre>\n<p>分别启动 soul-admin, soul-bootstrap, 注意目前使用http长连接,  bootstrap启动前需要soul-admin已经启动完成, 不然会由于无法通过http连接admin而无法启动,</p>\n<p>接下来正常启动我们看到soul-bootstrap log</p>\n\n    <pre><code class=\"lang-bash\"><span class=\"hljs-number\">2021</span>-<span class=\"hljs-number\">01</span>-<span class=\"hljs-number\">23</span> <span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">36</span>:08.<span class=\"hljs-number\">279</span>  INFO <span class=\"hljs-number\">62417</span> --- [           main] o.d.s.s.data.http.HttpSyncDataService    : request configs: [http://localhost:<span class=\"hljs-number\">9095</span>/configs/fetch?groupKeys=APP_AUTH&amp;groupKeys=PLUGIN&amp;groupKeys=RULE&amp;groupKeys=SELECTOR&amp;groupKeys=META_DATA]\n<span class=\"hljs-number\">2021</span>-<span class=\"hljs-number\">01</span>-<span class=\"hljs-number\">23</span> <span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">36</span>:08.<span class=\"hljs-number\">562</span>  INFO <span class=\"hljs-number\">62417</span> --- [onPool-worker-<span class=\"hljs-number\">3</span>] o.d.s.s.d.h.refresh.AppAuthDataRefresh   : clear all appAuth data cache\n<span class=\"hljs-number\">2021</span>-<span class=\"hljs-number\">01</span>-<span class=\"hljs-number\">23</span> <span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">36</span>:08.<span class=\"hljs-number\">570</span>  INFO <span class=\"hljs-number\">62417</span> --- [           main] o.d.s.s.data.http.HttpSyncDataService    : get latest configs: [{<span class=\"hljs-string\">\"code\"</span>:<span class=\"hljs-number\">200</span>,<span class=\"hljs-string\">\"message\"</span>:<span class=\"hljs-string\">\"success\"</span>,<span class=\"hljs-string\">\"data\"</span>:{<span class=\"hljs-string\">\"META_DATA\"</span>:{<span class=\"hljs-string\">\"md5\"</span>:<span class=\"hljs-string\">\"f96c44af66298be2e76a6b0a55a7b629\"</span>,<span class=\"hljs-string\">\"lastModifyTime\"</span>:<span class=\"hljs-number\">1611333355313</span>,<span class=\"hljs-string\">\"data\"</span>:[{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1351785376513667072\"</span>,<span class=\"hljs-string\">\"appName\"</span>:<span class=\"hljs-string\">\"springCloud-test\"</span>,<span class=\"hljs-string\">\"contextPath\"</span>:null,<span class=\"hljs-string\">\"path\"</span>:<span class=\"hljs-string\">\"/springcloud/**\"</span>,<span class=\"hljs-string\">\"rpcType\"</span>:<span class=\"hljs-string\">\"springCloud\"</span>,<span class=\"hljs-string\">\"serviceName\"</span>:<span class=\"hljs-string\">\"springCloud-test\"</span>,<span class=\"hljs-string\">\"methodName\"</span>:<span class=\"hljs-string\">\"/springcloud\"</span>,<span class=\"hljs-string\">\"parameterTypes\"</span>:null,<span class=\"hljs-string\">\"rpcExt\"</span>:null,<span class=\"hljs-string\">\"enabled\"</span>:true},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1351837754670669824\"</span>,<span class=\"hljs-string\">\"appName\"</span>:<span class=\"hljs-string\">\"sofa\"</span>,<span class=\"hljs-string\">\"contextPath\"</span>:null,<span class=\"hljs-string\">\"path\"</span>:<span class=\"hljs-string\">\"/sofa/insert\"</span>,<span class=\"hljs-string\">\"rpcType\"</span>:<span class=\"hljs-string\">\"sofa\"</span>,<span class=\"hljs-string\">\"serviceName\"</span>:<span class=\"hljs-string\">\"org.dromara.soul.examples.dubbo.api.service.DubboTestService\"</span>,<span class=\"hljs-string\">\"methodName\"</span>:<span class=\"hljs-string\">\"insert\"</span>,<span class=\"hljs-string\">\"parameterTypes\"</span>:<span class=\"hljs-string\">\"org.dromara.soul.examples.dubbo.api.entity.DubboTest\"</span>,<span class=\"hljs-string\">\"rpcExt\"</span>:<span class=\"hljs-string\">\"{\\\"</span>loadbalance\\<span class=\"hljs-string\">\":\\\"</span>hash\\<span class=\"hljs-string\">\",\\\"</span>retries\\<span class=\"hljs-string\">\":3,\\\"</span>timeout\\<span class=\"hljs-string\">\":-1}\"</span>,<span class=\"hljs-string\">\"enabled\"</span>:true},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1351837763067666432\"</span>,<span class=\"hljs-string\">\"appName\"</span>:<span class=\"hljs-string\">\"sofa\"</span>,<span class=\"hljs-string\">\"contextPath\"</span>:null,<span class=\"hljs-string\">\"path\"</span>:<span class=\"hljs-string\">\"/sofa/findAll\"</span>,<span class=\"hljs-string\">\"rpcType\"</span>:<span class=\"hljs-string\">\"sofa\"</span>,<span class=\"hljs-string\">\"serviceName\"</span>:<span class=\"hljs-string\">\"org.dromara.soul.examples.dubbo.api.service.DubboTestService\"</span>,<span class=\"hljs-string\">\"methodName\"</span>:<span class=\"hljs-string\">\"findAll\"</span>,<span class=\"hljs-string\">\"parameterTypes\"</span>:null,<span class=\"hljs-string\">\"rpcExt\"</span>:<span class=\"hljs-string\">\"{\\\"</span>loadbalance\\<span class=\"hljs-string\">\":\\\"</span>hash\\<span class=\"hljs-string\">\",\\\"</span>retries\\<span class=\"hljs-string\">\":3,\\\"</span>timeout\\<span class=\"hljs-string\">\":-1}\"</span>,<span class=\"hljs-string\">\"enabled\"</span>:true},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1351837768541233152\"</span>,<span class=\"hljs-string\">\"appName\"</span>:<span class=\"hljs-string\">\"sofa\"</span>,<span class=\"hljs-string\">\"contextPath\"</span>:null,<span class=\"hljs-string\">\"path\"</span>:<span class=\"hljs-string\">\"/sofa/findById\"</span>,<span class=\"hljs-string\">\"rpcType\"</span>:<span class=\"hljs-string\">\"sofa\"</span>,<span class=\"hljs-string\">\"serviceName\"</span>:<span class=\"hljs-string\">\"org.dromara.soul.examples.dubbo.api.service.DubboTestService\"</span>,<span class=\"hljs-string\">\"methodName\"</span>:<span class=\"hljs-string\">\"findById\"</span>,<span class=\"hljs-string\">\"parameterTypes\"</span>:<span class=\"hljs-string\">\"java.lang.String\"</span>,<span class=\"hljs-string\">\"rpcExt\"</span>:<span class=\"hljs-string\">\"{\\\"</span>loadbalance\\<span class=\"hljs-string\">\":\\\"</span>hash\\<span class=\"hljs-string\">\",\\\"</span>retries\\<span class=\"hljs-string\">\":3,\\\"</span>timeout\\<span class=\"hljs-string\">\":-1}\"</span>,<span class=\"hljs-string\">\"enabled\"</span>:true}]},<span class=\"hljs-string\">\"SELECTOR\"</span>:{<span class=\"hljs-string\">\"md5\"</span>:<span class=\"hljs-string\">\"55e041ea36b518946ef09f9ed5d16ffe\"</span>,<span class=\"hljs-string\">\"lastModifyTime\"</span>:<span class=\"hljs-number\">1611333355190</span>,<span class=\"hljs-string\">\"data\"</span>:[{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1351785378313023488\"</span>,<span class=\"hljs-string\">\"pluginId\"</span>:<span class=\"hljs-string\">\"8\"</span>,<span class=\"hljs-string\">\"pluginName\"</span>:<span class=\"hljs-string\">\"springCloud\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"/springcloud\"</span>,<span class=\"hljs-string\">\"matchMode\"</span>:<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">\"type\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"sort\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:true,<span class=\"hljs-string\">\"loged\"</span>:true,<span class=\"hljs-string\">\"continued\"</span>:true,<span class=\"hljs-string\">\"handle\"</span>:<span class=\"hljs-string\">\"{\\\"</span>serviceId\\<span class=\"hljs-string\">\":\\\"</span>springCloud-test\\<span class=\"hljs-string\">\"}\"</span>,<span class=\"hljs-string\">\"conditionList\"</span>:[{<span class=\"hljs-string\">\"paramType\"</span>:<span class=\"hljs-string\">\"uri\"</span>,<span class=\"hljs-string\">\"operator\"</span>:<span class=\"hljs-string\">\"match\"</span>,<span class=\"hljs-string\">\"paramName\"</span>:<span class=\"hljs-string\">\"/\"</span>,<span class=\"hljs-string\">\"paramValue\"</span>:<span class=\"hljs-string\">\"/springcloud/**\"</span>}]},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1351837756520357888\"</span>,<span class=\"hljs-string\">\"pluginId\"</span>:<span class=\"hljs-string\">\"11\"</span>,<span class=\"hljs-string\">\"pluginName\"</span>:<span class=\"hljs-string\">\"sofa\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"/sofa\"</span>,<span class=\"hljs-string\">\"matchMode\"</span>:<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">\"type\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"sort\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:true,<span class=\"hljs-string\">\"loged\"</span>:true,<span class=\"hljs-string\">\"continued\"</span>:true,<span class=\"hljs-string\">\"handle\"</span>:<span class=\"hljs-string\">\"sofa\"</span>,<span class=\"hljs-string\">\"conditionList\"</span>:[{<span class=\"hljs-string\">\"paramType\"</span>:<span class=\"hljs-string\">\"uri\"</span>,<span class=\"hljs-string\">\"operator\"</span>:<span class=\"hljs-string\">\"match\"</span>,<span class=\"hljs-string\">\"paramName\"</span>:<span class=\"hljs-string\">\"/\"</span>,<span class=\"hljs-string\">\"paramValue\"</span>:<span class=\"hljs-string\">\"/sofa/**\"</span>}]}]},<span class=\"hljs-string\">\"PLUGIN\"</span>:{<span class=\"hljs-string\">\"md5\"</span>:<span class=\"hljs-string\">\"5e9a7365763848a4498b445a5a35c0b4\"</span>,<span class=\"hljs-string\">\"lastModifyTime\"</span>:<span class=\"hljs-number\">1611333351898</span>,<span class=\"hljs-string\">\"data\"</span>:[{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"sign\"</span>,<span class=\"hljs-string\">\"config\"</span>:null,<span class=\"hljs-string\">\"role\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:false},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"10\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"sentinel\"</span>,<span class=\"hljs-string\">\"config\"</span>:null,<span class=\"hljs-string\">\"role\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:false},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"11\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"sofa\"</span>,<span class=\"hljs-string\">\"config\"</span>:<span class=\"hljs-string\">\"{\\\"</span>protocol\\<span class=\"hljs-string\">\":\\\"</span>zookeeper\\<span class=\"hljs-string\">\",\\\"</span>register\\<span class=\"hljs-string\">\":\\\"</span><span class=\"hljs-number\">127.0</span>.<span class=\"hljs-number\">0</span>.<span class=\"hljs-number\">1</span>:<span class=\"hljs-number\">2181</span>\\<span class=\"hljs-string\">\"}\"</span>,<span class=\"hljs-string\">\"role\"</span>:<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">\"enabled\"</span>:true},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"12\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"resilience4j\"</span>,<span class=\"hljs-string\">\"config\"</span>:null,<span class=\"hljs-string\">\"role\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:false},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"13\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"tars\"</span>,<span class=\"hljs-string\">\"config\"</span>:null,<span class=\"hljs-string\">\"role\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:false},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"14\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"context_path\"</span>,<span class=\"hljs-string\">\"config\"</span>:null,<span class=\"hljs-string\">\"role\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:false},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"2\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"waf\"</span>,<span class=\"hljs-string\">\"config\"</span>:<span class=\"hljs-string\">\"{\\\"</span>model\\<span class=\"hljs-string\">\":\\\"</span>black\\<span class=\"hljs-string\">\"}\"</span>,<span class=\"hljs-string\">\"role\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:false},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"3\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"rewrite\"</span>,<span class=\"hljs-string\">\"config\"</span>:null,<span class=\"hljs-string\">\"role\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:false},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"4\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"rate_limiter\"</span>,<span class=\"hljs-string\">\"config\"</span>:<span class=\"hljs-string\">\"{\\\"</span>master\\<span class=\"hljs-string\">\":\\\"</span>mymaster\\<span class=\"hljs-string\">\",\\\"</span>mode\\<span class=\"hljs-string\">\":\\\"</span>standalone\\<span class=\"hljs-string\">\",\\\"</span>url\\<span class=\"hljs-string\">\":\\\"</span><span class=\"hljs-number\">192.168</span>.<span class=\"hljs-number\">1.1</span>:<span class=\"hljs-number\">6379</span>\\<span class=\"hljs-string\">\",\\\"</span>password\\<span class=\"hljs-string\">\":\\\"</span>abc\\<span class=\"hljs-string\">\"}\"</span>,<span class=\"hljs-string\">\"role\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:false},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"5\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"divide\"</span>,<span class=\"hljs-string\">\"config\"</span>:null,<span class=\"hljs-string\">\"role\"</span>:<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">\"enabled\"</span>:true},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"6\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"dubbo\"</span>,<span class=\"hljs-string\">\"config\"</span>:<span class=\"hljs-string\">\"{\\\"</span>register\\<span class=\"hljs-string\">\":\\\"</span>zookeeper://localhost:<span class=\"hljs-number\">2181</span>\\<span class=\"hljs-string\">\"}\"</span>,<span class=\"hljs-string\">\"role\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:false},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"7\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"monitor\"</span>,<span class=\"hljs-string\">\"config\"</span>:<span class=\"hljs-string\">\"{\\\"</span>metricsName\\<span class=\"hljs-string\">\":\\\"</span>prometheus\\<span class=\"hljs-string\">\",\\\"</span>host\\<span class=\"hljs-string\">\":\\\"</span>localhost\\<span class=\"hljs-string\">\",\\\"</span>port\\<span class=\"hljs-string\">\":\\\"</span><span class=\"hljs-number\">9190</span>\\<span class=\"hljs-string\">\",\\\"</span>async\\<span class=\"hljs-string\">\":\\\"</span>true\\<span class=\"hljs-string\">\"}\"</span>,<span class=\"hljs-string\">\"role\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:false},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"8\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"springCloud\"</span>,<span class=\"hljs-string\">\"config\"</span>:null,<span class=\"hljs-string\">\"role\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:true},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"9\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"hystrix\"</span>,<span class=\"hljs-string\">\"config\"</span>:null,<span class=\"hljs-string\">\"role\"</span>:<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">\"enabled\"</span>:false}]},<span class=\"hljs-string\">\"APP_AUTH\"</span>:{<span class=\"hljs-string\">\"md5\"</span>:<span class=\"hljs-string\">\"d751713988987e9331980363e24189ce\"</span>,<span class=\"hljs-string\">\"lastModifyTime\"</span>:<span class=\"hljs-number\">1611333351778</span>,<span class=\"hljs-string\">\"data\"</span>:[]},<span class=\"hljs-string\">\"RULE\"</span>:{<span class=\"hljs-string\">\"md5\"</span>:<span class=\"hljs-string\">\"79088c310f2d3ec32a2c366957fc7165\"</span>,<span class=\"hljs-string\">\"lastModifyTime\"</span>:<span class=\"hljs-number\">1611333354636</span>,<span class=\"hljs-string\">\"data\"</span>:[{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1351785381014155264\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"/springcloud/order/findById\"</span>,<span class=\"hljs-string\">\"pluginName\"</span>:<span class=\"hljs-string\">\"springCloud\"</span>,<span class=\"hljs-string\">\"selectorId\"</span>:<span class=\"hljs-string\">\"1351785378313023488\"</span>,<span class=\"hljs-string\">\"matchMode\"</span>:<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">\"sort\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:true,<span class=\"hljs-string\">\"loged\"</span>:true,<span class=\"hljs-string\">\"handle\"</span>:<span class=\"hljs-string\">\"{\\\"</span>path\\<span class=\"hljs-string\">\":\\\"</span>/springcloud/order/findById\\<span class=\"hljs-string\">\",\\\"</span>timeout\\<span class=\"hljs-string\">\":3000}\"</span>,<span class=\"hljs-string\">\"conditionDataList\"</span>:[{<span class=\"hljs-string\">\"paramType\"</span>:<span class=\"hljs-string\">\"uri\"</span>,<span class=\"hljs-string\">\"operator\"</span>:<span class=\"hljs-string\">\"=\"</span>,<span class=\"hljs-string\">\"paramName\"</span>:<span class=\"hljs-string\">\"/\"</span>,<span class=\"hljs-string\">\"paramValue\"</span>:<span class=\"hljs-string\">\"/springcloud/order/findById\"</span>}]},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1351785386563219456\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"/springcloud/order/path/**\"</span>,<span class=\"hljs-string\">\"pluginName\"</span>:<span class=\"hljs-string\">\"springCloud\"</span>,<span class=\"hljs-string\">\"selectorId\"</span>:<span class=\"hljs-string\">\"1351785378313023488\"</span>,<span class=\"hljs-string\">\"matchMode\"</span>:<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">\"sort\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:true,<span class=\"hljs-string\">\"loged\"</span>:true,<span class=\"hljs-string\">\"handle\"</span>:<span class=\"hljs-string\">\"{\\\"</span>path\\<span class=\"hljs-string\">\":\\\"</span>/springcloud/order/path/**\\<span class=\"hljs-string\">\",\\\"</span>timeout\\<span class=\"hljs-string\">\":3000}\"</span>,<span class=\"hljs-string\">\"conditionDataList\"</span>:[{<span class=\"hljs-string\">\"paramType\"</span>:<span class=\"hljs-string\">\"uri\"</span>,<span class=\"hljs-string\">\"operator\"</span>:<span class=\"hljs-string\">\"match\"</span>,<span class=\"hljs-string\">\"paramName\"</span>:<span class=\"hljs-string\">\"/\"</span>,<span class=\"hljs-string\">\"paramValue\"</span>:<span class=\"hljs-string\">\"/springcloud/order/path/**\"</span>}]},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1351785391931928576\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"/springcloud/order/path/**/name\"</span>,<span class=\"hljs-string\">\"pluginName\"</span>:<span class=\"hljs-string\">\"springCloud\"</span>,<span class=\"hljs-string\">\"selectorId\"</span>:<span class=\"hljs-string\">\"1351785378313023488\"</span>,<span class=\"hljs-string\">\"matchMode\"</span>:<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">\"sort\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:true,<span class=\"hljs-string\">\"loged\"</span>:true,<span class=\"hljs-string\">\"handle\"</span>:<span class=\"hljs-string\">\"{\\\"</span>path\\<span class=\"hljs-string\">\":\\\"</span>/springcloud/order/path/**/name\\<span class=\"hljs-string\">\",\\\"</span>timeout\\<span class=\"hljs-string\">\":3000}\"</span>,<span class=\"hljs-string\">\"conditionDataList\"</span>:[{<span class=\"hljs-string\">\"paramType\"</span>:<span class=\"hljs-string\">\"uri\"</span>,<span class=\"hljs-string\">\"operator\"</span>:<span class=\"hljs-string\">\"match\"</span>,<span class=\"hljs-string\">\"paramName\"</span>:<span class=\"hljs-string\">\"/\"</span>,<span class=\"hljs-string\">\"paramValue\"</span>:<span class=\"hljs-string\">\"/springcloud/order/path/**/name\"</span>}]},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1351785398240161792\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"/springcloud/order/save\"</span>,<span class=\"hljs-string\">\"pluginName\"</span>:<span class=\"hljs-string\">\"springCloud\"</span>,<span class=\"hljs-string\">\"selectorId\"</span>:<span class=\"hljs-string\">\"1351785378313023488\"</span>,<span class=\"hljs-string\">\"matchMode\"</span>:<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">\"sort\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:true,<span class=\"hljs-string\">\"loged\"</span>:true,<span class=\"hljs-string\">\"handle\"</span>:<span class=\"hljs-string\">\"{\\\"</span>path\\<span class=\"hljs-string\">\":\\\"</span>/springcloud/order/save\\<span class=\"hljs-string\">\",\\\"</span>timeout\\<span class=\"hljs-string\">\":3000}\"</span>,<span class=\"hljs-string\">\"conditionDataList\"</span>:[{<span class=\"hljs-string\">\"paramType\"</span>:<span class=\"hljs-string\">\"uri\"</span>,<span class=\"hljs-string\">\"operator\"</span>:<span class=\"hljs-string\">\"=\"</span>,<span class=\"hljs-string\">\"paramName\"</span>:<span class=\"hljs-string\">\"/\"</span>,<span class=\"hljs-string\">\"paramValue\"</span>:<span class=\"hljs-string\">\"/springcloud/order/save\"</span>}]},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1351785403906666496\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"/springcloud/test/**\"</span>,<span class=\"hljs-string\">\"pluginName\"</span>:<span class=\"hljs-string\">\"springCloud\"</span>,<span class=\"hljs-string\">\"selectorId\"</span>:<span class=\"hljs-string\">\"1351785378313023488\"</span>,<span class=\"hljs-string\">\"matchMode\"</span>:<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">\"sort\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:true,<span class=\"hljs-string\">\"loged\"</span>:true,<span class=\"hljs-string\">\"handle\"</span>:<span class=\"hljs-string\">\"{\\\"</span>path\\<span class=\"hljs-string\">\":\\\"</span>/springcloud/test/**\\<span class=\"hljs-string\">\",\\\"</span>timeout\\<span class=\"hljs-string\">\":3000}\"</span>,<span class=\"hljs-string\">\"conditionDataList\"</span>:[{<span class=\"hljs-string\">\"paramType\"</span>:<span class=\"hljs-string\">\"uri\"</span>,<span class=\"hljs-string\">\"operator\"</span>:<span class=\"hljs-string\">\"match\"</span>,<span class=\"hljs-string\">\"paramName\"</span>:<span class=\"hljs-string\">\"/\"</span>,<span class=\"hljs-string\">\"paramValue\"</span>:<span class=\"hljs-string\">\"/springcloud/test/**\"</span>}]},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1351837759351513088\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"/sofa/insert\"</span>,<span class=\"hljs-string\">\"pluginName\"</span>:<span class=\"hljs-string\">\"sofa\"</span>,<span class=\"hljs-string\">\"selectorId\"</span>:<span class=\"hljs-string\">\"1351837756520357888\"</span>,<span class=\"hljs-string\">\"matchMode\"</span>:<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">\"sort\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:true,<span class=\"hljs-string\">\"loged\"</span>:true,<span class=\"hljs-string\">\"handle\"</span>:<span class=\"hljs-string\">\"{\\\"</span>retries\\<span class=\"hljs-string\">\":0,\\\"</span>loadBalance\\<span class=\"hljs-string\">\":\\\"</span>random\\<span class=\"hljs-string\">\",\\\"</span>timeout\\<span class=\"hljs-string\">\":3000}\"</span>,<span class=\"hljs-string\">\"conditionDataList\"</span>:[{<span class=\"hljs-string\">\"paramType\"</span>:<span class=\"hljs-string\">\"uri\"</span>,<span class=\"hljs-string\">\"operator\"</span>:<span class=\"hljs-string\">\"=\"</span>,<span class=\"hljs-string\">\"paramName\"</span>:<span class=\"hljs-string\">\"/\"</span>,<span class=\"hljs-string\">\"paramValue\"</span>:<span class=\"hljs-string\">\"/sofa/insert\"</span>}]},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1351837764875411456\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"/sofa/findAll\"</span>,<span class=\"hljs-string\">\"pluginName\"</span>:<span class=\"hljs-string\">\"sofa\"</span>,<span class=\"hljs-string\">\"selectorId\"</span>:<span class=\"hljs-string\">\"1351837756520357888\"</span>,<span class=\"hljs-string\">\"matchMode\"</span>:<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">\"sort\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:true,<span class=\"hljs-string\">\"loged\"</span>:true,<span class=\"hljs-string\">\"handle\"</span>:<span class=\"hljs-string\">\"{\\\"</span>retries\\<span class=\"hljs-string\">\":0,\\\"</span>loadBalance\\<span class=\"hljs-string\">\":\\\"</span>random\\<span class=\"hljs-string\">\",\\\"</span>timeout\\<span class=\"hljs-string\">\":3000}\"</span>,<span class=\"hljs-string\">\"conditionDataList\"</span>:[{<span class=\"hljs-string\">\"paramType\"</span>:<span class=\"hljs-string\">\"uri\"</span>,<span class=\"hljs-string\">\"operator\"</span>:<span class=\"hljs-string\">\"=\"</span>,<span class=\"hljs-string\">\"paramName\"</span>:<span class=\"hljs-string\">\"/\"</span>,<span class=\"hljs-string\">\"paramValue\"</span>:<span class=\"hljs-string\">\"/sofa/findAll\"</span>}]},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1351837770344783872\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"/sofa/findById\"</span>,<span class=\"hljs-string\">\"pluginName\"</span>:<span class=\"hljs-string\">\"sofa\"</span>,<span class=\"hljs-string\">\"selectorId\"</span>:<span class=\"hljs-string\">\"1351837756520357888\"</span>,<span class=\"hljs-string\">\"matchMode\"</span>:<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">\"sort\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:true,<span class=\"hljs-string\">\"loged\"</span>:true,<span class=\"hljs-string\">\"handle\"</span>:<span class=\"hljs-string\">\"{\\\"</span>retries\\<span class=\"hljs-string\">\":0,\\\"</span>loadBalance\\<span class=\"hljs-string\">\":\\\"</span>random\\<span class=\"hljs-string\">\",\\\"</span>timeout\\<span class=\"hljs-string\">\":3000}\"</span>,<span class=\"hljs-string\">\"conditionDataList\"</span>:[{<span class=\"hljs-string\">\"paramType\"</span>:<span class=\"hljs-string\">\"uri\"</span>,<span class=\"hljs-string\">\"operator\"</span>:<span class=\"hljs-string\">\"=\"</span>,<span class=\"hljs-string\">\"paramName\"</span>:<span class=\"hljs-string\">\"/\"</span>,<span class=\"hljs-string\">\"paramValue\"</span>:<span class=\"hljs-string\">\"/sofa/findById\"</span>}]}]}}}]\n</code></pre>\n<p>显然我们通过 <a href=\"http://localhost:9095/configs/fetch\" target=\"_blank\" rel=\"external\">http://localhost:9095/configs/fetch</a> 同步了配置</p>\n<p>接下来修改一个配置,可以看到</p>\n<p><img src=\"/2021/01/23/soul-gateway-src-code-learning-08/00change_config.png\" alt=\"img\"></p>\n<p>admin log</p>\n\n    <pre><code class=\"lang-bash\">2021-01-23 00:42:55.071  <span class=\"hljs-builtin-name\">INFO</span> 62391 --- [0.0-9095-exec-5] o.d.s.a.l.AbstractDataChangedListener    : update<span class=\"hljs-built_in\"> config </span>cache[SELECTOR], old: {<span class=\"hljs-attribute\">group</span>=<span class=\"hljs-string\">'SELECTOR'</span>, <span class=\"hljs-attribute\">md5</span>=<span class=\"hljs-string\">'55e041ea36b518946ef09f9ed5d16ffe'</span>, <span class=\"hljs-attribute\">lastModifyTime</span>=1611333660488}, updated: {<span class=\"hljs-attribute\">group</span>=<span class=\"hljs-string\">'SELECTOR'</span>, <span class=\"hljs-attribute\">md5</span>=<span class=\"hljs-string\">'c8fa3ad3868f3ea1947f3641c753e888'</span>, <span class=\"hljs-attribute\">lastModifyTime</span>=1611333775071}\n2021-01-23 00:42:55.077  <span class=\"hljs-builtin-name\">INFO</span> 62391 --- [-long-polling-2] a.l.h.HttpLongPollingDataChangedListener : send response with the changed group,<span class=\"hljs-attribute\">ip</span>=127.0.0.1, <span class=\"hljs-attribute\">group</span>=SELECTOR, <span class=\"hljs-attribute\">changeTime</span>=1611333775074\n</code></pre>\n<p>bootstrap log, 看上去像是受到通知,然后去拉的配置</p>\n\n    <pre><code class=\"lang-bash\"><span class=\"hljs-number\">2021</span>-<span class=\"hljs-number\">01</span>-<span class=\"hljs-number\">23</span> <span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">42</span>:<span class=\"hljs-number\">55.079</span>  INFO <span class=\"hljs-number\">62417</span> --- [-long-polling-<span class=\"hljs-number\">1</span>] o.d.s.s.data.http.HttpSyncDataService    : Group config changed: [SELECTOR]\n<span class=\"hljs-number\">2021</span>-<span class=\"hljs-number\">01</span>-<span class=\"hljs-number\">23</span> <span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">42</span>:<span class=\"hljs-number\">55.081</span>  INFO <span class=\"hljs-number\">62417</span> --- [-long-polling-<span class=\"hljs-number\">1</span>] o.d.s.s.data.http.HttpSyncDataService    : request configs: [http://localhost:<span class=\"hljs-number\">9095</span>/configs/fetch?<span class=\"hljs-attr\">groupKeys=SELECTOR]</span>\n<span class=\"hljs-number\">2021</span>-<span class=\"hljs-number\">01</span>-<span class=\"hljs-number\">23</span> <span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">42</span>:<span class=\"hljs-number\">55.127</span>  INFO <span class=\"hljs-number\">62417</span> --- [-long-polling-<span class=\"hljs-number\">1</span>] o.d.s.s.d.h.refresh.AbstractDataRefresh  : update SELECTOR config: {<span class=\"hljs-string\">\"md5\"</span>:<span class=\"hljs-string\">\"c8fa3ad3868f3ea1947f3641c753e888\"</span>,<span class=\"hljs-string\">\"lastModifyTime\"</span>:<span class=\"hljs-number\">1611333775071</span>,<span class=\"hljs-string\">\"data\"</span>:[{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1351785378313023488\"</span>,<span class=\"hljs-string\">\"pluginId\"</span>:<span class=\"hljs-string\">\"8\"</span>,<span class=\"hljs-string\">\"pluginName\"</span>:<span class=\"hljs-string\">\"springCloud\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"/springcloud\"</span>,<span class=\"hljs-string\">\"matchMode\"</span>:<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">\"type\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"sort\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:<span class=\"hljs-literal\">true</span>,<span class=\"hljs-string\">\"loged\"</span>:<span class=\"hljs-literal\">true</span>,<span class=\"hljs-string\">\"continued\"</span>:<span class=\"hljs-literal\">true</span>,<span class=\"hljs-string\">\"handle\"</span>:<span class=\"hljs-string\">\"{\\\"</span>serviceId\\<span class=\"hljs-string\">\":\\\"</span>springCloud-test\\<span class=\"hljs-string\">\"}\"</span>,<span class=\"hljs-string\">\"conditionList\"</span>:[{<span class=\"hljs-string\">\"paramType\"</span>:<span class=\"hljs-string\">\"uri\"</span>,<span class=\"hljs-string\">\"operator\"</span>:<span class=\"hljs-string\">\"match\"</span>,<span class=\"hljs-string\">\"paramName\"</span>:<span class=\"hljs-string\">\"/\"</span>,<span class=\"hljs-string\">\"paramValue\"</span>:<span class=\"hljs-string\">\"/springcloud/**\"</span>}]},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1351837756520357888\"</span>,<span class=\"hljs-string\">\"pluginId\"</span>:<span class=\"hljs-string\">\"11\"</span>,<span class=\"hljs-string\">\"pluginName\"</span>:<span class=\"hljs-string\">\"sofa\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"/sofa\"</span>,<span class=\"hljs-string\">\"matchMode\"</span>:<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">\"type\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"sort\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:<span class=\"hljs-literal\">true</span>,<span class=\"hljs-string\">\"loged\"</span>:<span class=\"hljs-literal\">true</span>,<span class=\"hljs-string\">\"continued\"</span>:<span class=\"hljs-literal\">true</span>,<span class=\"hljs-string\">\"handle\"</span>:<span class=\"hljs-string\">\"sofa\"</span>,<span class=\"hljs-string\">\"conditionList\"</span>:[{<span class=\"hljs-string\">\"paramType\"</span>:<span class=\"hljs-string\">\"uri\"</span>,<span class=\"hljs-string\">\"operator\"</span>:<span class=\"hljs-string\">\"match\"</span>,<span class=\"hljs-string\">\"paramName\"</span>:<span class=\"hljs-string\">\"/\"</span>,<span class=\"hljs-string\">\"paramValue\"</span>:<span class=\"hljs-string\">\"/sofa/**\"</span>}]},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1352658003622137856\"</span>,<span class=\"hljs-string\">\"pluginId\"</span>:<span class=\"hljs-string\">\"5\"</span>,<span class=\"hljs-string\">\"pluginName\"</span>:<span class=\"hljs-string\">\"divide\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"mo\"</span>,<span class=\"hljs-string\">\"matchMode\"</span>:<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">\"type\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"sort\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:<span class=\"hljs-literal\">true</span>,<span class=\"hljs-string\">\"loged\"</span>:<span class=\"hljs-literal\">true</span>,<span class=\"hljs-string\">\"continued\"</span>:<span class=\"hljs-literal\">true</span>,<span class=\"hljs-string\">\"handle\"</span>:<span class=\"hljs-string\">\"[{\\\"</span>upstreamHost\\<span class=\"hljs-string\">\":\\\"</span>baidu.com\\<span class=\"hljs-string\">\",\\\"</span>protocol\\<span class=\"hljs-string\">\":\\\"</span>http://\\<span class=\"hljs-string\">\",\\\"</span>upstreamUrl\\<span class=\"hljs-string\">\":\\\"</span>baidu.com\\<span class=\"hljs-string\">\",\\\"</span>weight\\<span class=\"hljs-string\">\":\\\"</span><span class=\"hljs-number\">50</span>\\<span class=\"hljs-string\">\",\\\"</span>status\\<span class=\"hljs-string\">\":true,\\\"</span>timestamp\\<span class=\"hljs-string\">\":\\\"</span><span class=\"hljs-number\">0</span>\\<span class=\"hljs-string\">\",\\\"</span>warmup\\<span class=\"hljs-string\">\":\\\"</span><span class=\"hljs-number\">0</span>\\<span class=\"hljs-string\">\"}]\"</span>,<span class=\"hljs-string\">\"conditionList\"</span>:[{<span class=\"hljs-string\">\"paramType\"</span>:<span class=\"hljs-string\">\"uri\"</span>,<span class=\"hljs-string\">\"operator\"</span>:<span class=\"hljs-string\">\"\\u003d\"</span>,<span class=\"hljs-string\">\"paramName\"</span>:<span class=\"hljs-string\">\"/\"</span>,<span class=\"hljs-string\">\"paramValue\"</span>:<span class=\"hljs-string\">\"/\"</span>}]}]}\n<span class=\"hljs-number\">2021</span>-<span class=\"hljs-number\">01</span>-<span class=\"hljs-number\">23</span> <span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">42</span>:<span class=\"hljs-number\">55.135</span>  INFO <span class=\"hljs-number\">62417</span> --- [-long-polling-<span class=\"hljs-number\">1</span>] o.d.s.s.data.http.HttpSyncDataService    : get latest configs: [{<span class=\"hljs-string\">\"code\"</span>:<span class=\"hljs-number\">200</span>,<span class=\"hljs-string\">\"message\"</span>:<span class=\"hljs-string\">\"success\"</span>,<span class=\"hljs-string\">\"data\"</span>:{<span class=\"hljs-string\">\"SELECTOR\"</span>:{<span class=\"hljs-string\">\"md5\"</span>:<span class=\"hljs-string\">\"c8fa3ad3868f3ea1947f3641c753e888\"</span>,<span class=\"hljs-string\">\"lastModifyTime\"</span>:<span class=\"hljs-number\">1611333775071</span>,<span class=\"hljs-string\">\"data\"</span>:[{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1351785378313023488\"</span>,<span class=\"hljs-string\">\"pluginId\"</span>:<span class=\"hljs-string\">\"8\"</span>,<span class=\"hljs-string\">\"pluginName\"</span>:<span class=\"hljs-string\">\"springCloud\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"/springcloud\"</span>,<span class=\"hljs-string\">\"matchMode\"</span>:<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">\"type\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"sort\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:<span class=\"hljs-literal\">true</span>,<span class=\"hljs-string\">\"loged\"</span>:<span class=\"hljs-literal\">true</span>,<span class=\"hljs-string\">\"continued\"</span>:<span class=\"hljs-literal\">true</span>,<span class=\"hljs-string\">\"handle\"</span>:<span class=\"hljs-string\">\"{\\\"</span>serviceId\\<span class=\"hljs-string\">\":\\\"</span>springCloud-test\\<span class=\"hljs-string\">\"}\"</span>,<span class=\"hljs-string\">\"conditionList\"</span>:[{<span class=\"hljs-string\">\"paramType\"</span>:<span class=\"hljs-string\">\"uri\"</span>,<span class=\"hljs-string\">\"operator\"</span>:<span class=\"hljs-string\">\"match\"</span>,<span class=\"hljs-string\">\"paramName\"</span>:<span class=\"hljs-string\">\"/\"</span>,<span class=\"hljs-string\">\"paramValue\"</span>:<span class=\"hljs-string\">\"/springcloud/**\"</span>}]},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1351837756520357888\"</span>,<span class=\"hljs-string\">\"pluginId\"</span>:<span class=\"hljs-string\">\"11\"</span>,<span class=\"hljs-string\">\"pluginName\"</span>:<span class=\"hljs-string\">\"sofa\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"/sofa\"</span>,<span class=\"hljs-string\">\"matchMode\"</span>:<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">\"type\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"sort\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:<span class=\"hljs-literal\">true</span>,<span class=\"hljs-string\">\"loged\"</span>:<span class=\"hljs-literal\">true</span>,<span class=\"hljs-string\">\"continued\"</span>:<span class=\"hljs-literal\">true</span>,<span class=\"hljs-string\">\"handle\"</span>:<span class=\"hljs-string\">\"sofa\"</span>,<span class=\"hljs-string\">\"conditionList\"</span>:[{<span class=\"hljs-string\">\"paramType\"</span>:<span class=\"hljs-string\">\"uri\"</span>,<span class=\"hljs-string\">\"operator\"</span>:<span class=\"hljs-string\">\"match\"</span>,<span class=\"hljs-string\">\"paramName\"</span>:<span class=\"hljs-string\">\"/\"</span>,<span class=\"hljs-string\">\"paramValue\"</span>:<span class=\"hljs-string\">\"/sofa/**\"</span>}]},{<span class=\"hljs-string\">\"id\"</span>:<span class=\"hljs-string\">\"1352658003622137856\"</span>,<span class=\"hljs-string\">\"pluginId\"</span>:<span class=\"hljs-string\">\"5\"</span>,<span class=\"hljs-string\">\"pluginName\"</span>:<span class=\"hljs-string\">\"divide\"</span>,<span class=\"hljs-string\">\"name\"</span>:<span class=\"hljs-string\">\"mo\"</span>,<span class=\"hljs-string\">\"matchMode\"</span>:<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">\"type\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"sort\"</span>:<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">\"enabled\"</span>:<span class=\"hljs-literal\">true</span>,<span class=\"hljs-string\">\"loged\"</span>:<span class=\"hljs-literal\">true</span>,<span class=\"hljs-string\">\"continued\"</span>:<span class=\"hljs-literal\">true</span>,<span class=\"hljs-string\">\"handle\"</span>:<span class=\"hljs-string\">\"[{\\\"</span>upstreamHost\\<span class=\"hljs-string\">\":\\\"</span>baidu.com\\<span class=\"hljs-string\">\",\\\"</span>protocol\\<span class=\"hljs-string\">\":\\\"</span>http://\\<span class=\"hljs-string\">\",\\\"</span>upstreamUrl\\<span class=\"hljs-string\">\":\\\"</span>baidu.com\\<span class=\"hljs-string\">\",\\\"</span>weight\\<span class=\"hljs-string\">\":\\\"</span><span class=\"hljs-number\">50</span>\\<span class=\"hljs-string\">\",\\\"</span>status\\<span class=\"hljs-string\">\":true,\\\"</span>timestamp\\<span class=\"hljs-string\">\":\\\"</span><span class=\"hljs-number\">0</span>\\<span class=\"hljs-string\">\",\\\"</span>warmup\\<span class=\"hljs-string\">\":\\\"</span><span class=\"hljs-number\">0</span>\\<span class=\"hljs-string\">\"}]\"</span>,<span class=\"hljs-string\">\"conditionList\"</span>:[{<span class=\"hljs-string\">\"paramType\"</span>:<span class=\"hljs-string\">\"uri\"</span>,<span class=\"hljs-string\">\"operator\"</span>:<span class=\"hljs-string\">\"=\"</span>,<span class=\"hljs-string\">\"paramName\"</span>:<span class=\"hljs-string\">\"/\"</span>,<span class=\"hljs-string\">\"paramValue\"</span>:<span class=\"hljs-string\">\"/\"</span>}]}]}}}]\n</code></pre>\n<p>根据log查看HttpSyncDataService逻辑, 同样实现了SyncDataService接口</p>\n\n    <pre><code class=\"lang-java\"><span class=\"hljs-comment\">//构造方法调用start方法</span>\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">start</span><span class=\"hljs-params\">()</span> </span>{\n        <span class=\"hljs-comment\">// It could be initialized multiple times, so you need to control that.</span>\n        <span class=\"hljs-keyword\">if</span> (RUNNING.compareAndSet(<span class=\"hljs-literal\">false</span>, <span class=\"hljs-literal\">true</span>)) {\n            <span class=\"hljs-comment\">// fetch all group configs.</span>\n            <span class=\"hljs-keyword\">this</span>.fetchGroupConfig(ConfigGroupEnum.values());\n            <span class=\"hljs-keyword\">int</span> threadSize = serverList.size();\n            <span class=\"hljs-keyword\">this</span>.executor = <span class=\"hljs-keyword\">new</span> ThreadPoolExecutor(threadSize, threadSize, <span class=\"hljs-number\">60L</span>, TimeUnit.SECONDS,\n                    <span class=\"hljs-keyword\">new</span> LinkedBlockingQueue&lt;&gt;(),\n                    SoulThreadFactory.create(<span class=\"hljs-string\">\"http-long-polling\"</span>, <span class=\"hljs-literal\">true</span>));\n            <span class=\"hljs-comment\">// start long polling, each server creates a thread to listen for changes.</span>\n            <span class=\"hljs-keyword\">this</span>.serverList.forEach(server -&gt; <span class=\"hljs-keyword\">this</span>.executor.execute(<span class=\"hljs-keyword\">new</span> HttpLongPollingTask(server)));\n        } <span class=\"hljs-keyword\">else</span> {\n            <span class=\"hljs-built_in\">log</span>.info(<span class=\"hljs-string\">\"soul http long polling was started, executor=[{}]\"</span>, executor);\n        }\n    }\n</code></pre>\n\n    <pre><code class=\"lang-java\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">HttpLongPollingTask</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">Runnable</span> </span>{\n\n        <span class=\"hljs-keyword\">private</span> String <span class=\"hljs-keyword\">server</span>;\n\n        <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> <span class=\"hljs-keyword\">int</span> retryTimes = <span class=\"hljs-number\">3</span>;\n\n        HttpLongPollingTask(<span class=\"hljs-keyword\">final</span> String <span class=\"hljs-keyword\">server</span>) {\n            <span class=\"hljs-keyword\">this</span>.<span class=\"hljs-keyword\">server</span> = <span class=\"hljs-keyword\">server</span>;\n        }\n\n        @Override\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> run() {\n            <span class=\"hljs-keyword\">while</span> (RUNNING.get()) {\n                <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">int</span> time = <span class=\"hljs-number\">1</span>; time &lt;= retryTimes; time++) {\n                    <span class=\"hljs-keyword\">try</span> {\n                      <span class=\"hljs-comment\">//核心长轮询, 看下面</span>\n                        doLongPolling(<span class=\"hljs-keyword\">server</span>);\n                    } <span class=\"hljs-keyword\">catch</span> (Exception e) {\n                        <span class=\"hljs-comment\">// print warnning log.</span>\n                        <span class=\"hljs-keyword\">if</span> (time &lt; retryTimes) {\n                            log.warn(<span class=\"hljs-string\">\"Long polling failed, tried {} times, {} times left, will be suspended for a while! {}\"</span>,\n                                    time, retryTimes - time, e.getMessage());\n                            ThreadUtils.sleep(TimeUnit.SECONDS, <span class=\"hljs-number\">5</span>);\n                            <span class=\"hljs-keyword\">continue</span>;\n                        }\n                        <span class=\"hljs-comment\">// print error, then suspended for a while.</span>\n                        log.error(<span class=\"hljs-string\">\"Long polling failed, try again after 5 minutes!\"</span>, e);\n                        ThreadUtils.sleep(TimeUnit.MINUTES, <span class=\"hljs-number\">5</span>);\n                    }\n                }\n            }\n            log.warn(<span class=\"hljs-string\">\"Stop http long polling.\"</span>);\n        }\n    }\n</code></pre>\n\n    <pre><code class=\"lang-java\"><span class=\"hljs-keyword\">private</span> void doLongPolling(final <span class=\"hljs-keyword\">String</span> server) {\n        MultiValueMap&lt;<span class=\"hljs-keyword\">String</span>, <span class=\"hljs-keyword\">String</span>&gt; params = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-type\">LinkedMultiValueMap</span>&lt;&gt;(<span class=\"hljs-number\">8</span>);\n        <span class=\"hljs-keyword\">for</span> (ConfigGroupEnum group : <span class=\"hljs-type\">ConfigGroupEnum</span>.values()) {\n            ConfigData&lt;?&gt; cacheConfig = factory.cacheConfigData(group);\n            <span class=\"hljs-keyword\">String</span> value = <span class=\"hljs-keyword\">String</span>.join(<span class=\"hljs-string\">\",\"</span>, cacheConfig.getMd5(), <span class=\"hljs-keyword\">String</span>.valueOf(cacheConfig.getLastModifyTime()));\n            params.put(group.name(), Lists.<span class=\"hljs-keyword\">new</span><span class=\"hljs-type\">ArrayList</span>(value));\n        }\n        HttpHeaders headers = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-type\">HttpHeaders</span>();\n        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);\n        HttpEntity httpEntity = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-type\">HttpEntity</span>(params, headers);\n        <span class=\"hljs-keyword\">String</span> listenerUrl = server + <span class=\"hljs-string\">\"/configs/listener\"</span>;\n        log.debug(<span class=\"hljs-string\">\"request listener configs: [{}]\"</span>, listenerUrl);\n        JsonArray groupJson = <span class=\"hljs-literal\">null</span>;\n        <span class=\"hljs-keyword\">try</span> {\n          <span class=\"hljs-comment\">//请求listener查看是否有变坏</span>\n            <span class=\"hljs-keyword\">String</span> json = <span class=\"hljs-built_in\">this</span>.httpClient.postForEntity(listenerUrl, httpEntity, <span class=\"hljs-keyword\">String</span>.class).getBody();\n            log.debug(<span class=\"hljs-string\">\"listener result: [{}]\"</span>, json);\n            groupJson = GSON.fromJson(json, JsonObject.class).getAsJsonArray(<span class=\"hljs-string\">\"data\"</span>);\n        } <span class=\"hljs-keyword\">catch</span> (RestClientException e) {\n            <span class=\"hljs-keyword\">String</span> message = <span class=\"hljs-keyword\">String</span>.format(<span class=\"hljs-string\">\"listener configs fail, server:[%s], %s\"</span>, server, e.getMessage());\n            <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-type\">SoulException</span>(message, e);\n        }\n\n        <span class=\"hljs-keyword\">if</span> (groupJson != <span class=\"hljs-literal\">null</span>) {\n            <span class=\"hljs-comment\">// fetch group configuration async.</span>\n            ConfigGroupEnum[] changedGroups = GSON.fromJson(groupJson, ConfigGroupEnum[].class);\n            <span class=\"hljs-keyword\">if</span> (ArrayUtils.isNotEmpty(changedGroups)) {\n                log.info(<span class=\"hljs-string\">\"Group config changed: {}\"</span>, Arrays.toString(changedGroups));\n              <span class=\"hljs-comment\">//如果有变化,发送请求获取配置</span>\n                <span class=\"hljs-built_in\">this</span>.doFetchGroupConfig(server, changedGroups);\n            }\n        }\n    }\n</code></pre>\n<p>CongfigController</p>\n\n    <pre><code class=\"lang-java\"><span class=\"hljs-comment\">//依赖于HttpLongPollingDataChangedListener, HttpLongPollingDataChangedListener依赖于配置的soul.sync.http.enable</span>\n<span class=\"hljs-variable\">@ConditionalOnBean</span>(HttpLongPollingDataChangedListener.class)\n<span class=\"hljs-variable\">@RestController</span>\n<span class=\"hljs-variable\">@RequestMapping</span>(<span class=\"hljs-string\">\"/configs\"</span>)\n<span class=\"hljs-variable\">@Slf4j</span>\npublic class ConfigController {\n    <span class=\"hljs-variable\">@PostMapping</span>(value = <span class=\"hljs-string\">\"/listener\"</span>)\n    public void listener(final HttpServletRequest request, final HttpServletResponse response) {\n        <span class=\"hljs-selector-tag\">longPollingListener</span><span class=\"hljs-selector-class\">.doLongPolling</span>(request, response);\n    }\n}\n</code></pre>\n\n    <pre><code class=\"lang-java\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> doLongPolling(<span class=\"hljs-keyword\">final</span> HttpServletRequest request, <span class=\"hljs-keyword\">final</span> HttpServletResponse response) {\n\n        <span class=\"hljs-comment\">//对比请求携带的配置md5, 如果与当前不一致证明已经更新, 这里面细节就先不详看了</span>\n        List&lt;ConfigGroupEnum&gt; changedGroup = compareChangedGroup(request);\n        <span class=\"hljs-keyword\">String</span> clientIp = getRemoteIp(request);\n\n        <span class=\"hljs-comment\">// 如果有变化直接就返回 变化的配置group</span>\n        <span class=\"hljs-keyword\">if</span> (CollectionUtils.isNotEmpty(changedGroup)) {\n            <span class=\"hljs-keyword\">this</span>.generateResponse(response, changedGroup);\n            <span class=\"hljs-built_in\">log</span>.info(<span class=\"hljs-string\">\"send response with the changed group, ip={}, group={}\"</span>, clientIp, changedGroup);\n            <span class=\"hljs-keyword\">return</span>;\n        }\n\n        <span class=\"hljs-comment\">// listen for configuration changed.</span>\n        <span class=\"hljs-keyword\">final</span> AsyncContext asyncContext = request.startAsync();\n\n        <span class=\"hljs-comment\">// AsyncContext.settimeout() does not timeout properly, so you have to control it yourself</span>\n        asyncContext.setTimeout(<span class=\"hljs-number\">0</span>L);\n\n        <span class=\"hljs-comment\">// block client's thread.</span>\n        scheduler.execute(<span class=\"hljs-keyword\">new</span> LongPollingClient(asyncContext, clientIp, HttpConstants.SERVER_MAX_HOLD_TIMEOUT));\n    }\n</code></pre>\n","categories":[],"tags":[]}