{"title":"soul_gateway_src_code_learning_01","slug":"soul-gateway-src-code-learning-01","date":"2021-01-14T16:07:03.000Z","updated":"2021-01-24T17:23:15.044Z","comments":true,"excerpt":"","content":"<h2 id=\"Soul\"><a href=\"#Soul\" class=\"headerlink\" title=\"Soul\"></a>Soul</h2><p>这是一个异步的,高性能的,跨语言的,响应式的API网关。我希望能够有一样东西像灵魂一样，保护您的微服务。参考了Kong，Spring-Cloud-Gateway等优秀的网关后，站在巨人的肩膀上，Soul由此诞生！</p>\n<h2 id=\"Features\"><a href=\"#Features\" class=\"headerlink\" title=\"Features\"></a>Features</h2><ul>\n<li>支持各种语言(http协议)，支持 dubbo，springcloud协议。</li>\n<li>插件化设计思想，插件热插拔,易扩展。</li>\n<li>灵活的流量筛选，能满足各种流量控制。</li>\n<li>内置丰富的插件支持，鉴权，限流，熔断，防火墙等等。</li>\n<li>流量配置动态化，性能极高，网关消耗在 1~2ms。</li>\n<li>支持集群部署，支持 A/B Test, 蓝绿发布。</li>\n</ul>\n<p><a href=\"https://dromara.org/zh-cn/docs/soul/soul.html\" target=\"_blank\" rel=\"external\">官方文档</a></p>\n<p><a href=\"https://github.com/dromara/soul\" target=\"_blank\" rel=\"external\">Github repo</a></p>\n<p>本人使用的是 master分支 b1ed3daa87a1633cc6c5cc131baa0cdd78df643c 版本, 未来可能会有略微不同</p>\n<pre><code class=\"shell\"># clone repo 到本地\ngit clone https://github.com/dromara/soul\n# 然后进行编译项目:\nmvn clean package install -Dmaven.test.skip=true -Dmaven.javadoc.skip=true -Drat.skip=true -Dcheckstyle.skip=true\n\n# 编译中会遇到有些包找不到的问题, 主动地去编译相应的模块就好, 重复此步骤\n# eg:\nmvn clean package install -Dmaven.test.skip=true -Dmaven.javadoc.skip=true -Drat.skip=true -Dcheckstyle.skip=true -f soul-plugin/soul-plugin-monitor/pom.xml\n</code></pre>\n<p>编辑 soul-admin的配置文件 soul-admin/src/main/resources/application.yml</p>\n<pre><code class=\"yaml\"># 去掉h2配置文件的注释\nspring:\n  profiles:\n    active: h2\n# 或者配置mysql数据库\ndatasource:\n    url: jdbc:mysql://localhost:3306/soul?useUnicode=true&amp;characterEncoding=utf-8\n    username: root\n    password:\n    driver-class-name: com.mysql.jdbc.Driver\n</code></pre>\n<p>在IDEA中运行 soul-admin 的入口函数 soul-admin/src/main/java/org/dromara/soul/admin/SoulAdminBootstrap.java</p>\n<p>访问 <a href=\"http://127.0.0.1:9095\" target=\"_blank\" rel=\"external\">http://127.0.0.1:9095</a> 我们就看到首页了</p>\n<p><img src=\"/2021/01/15/soul-gateway-src-code-learning-01/00login.png\" alt=\"pic\"></p>\n<p>默认的 账号: <strong>admin</strong> 密码:<strong>123456</strong></p>\n<p><img src=\"/2021/01/15/soul-gateway-src-code-learning-01/01index.png\" alt=\"pic\"></p>\n<p>随后在IDEA中运行 soul-bootstrap 的入口函数 soul-bootstrap/src/main/java/org/dromara/soul/bootstrap/SoulBootstrapApplication.java</p>\n<p><img src=\"/2021/01/15/soul-gateway-src-code-learning-01/02start_bootstrap_log.jpg\" alt=\"pic\"></p>\n<p>注意这个log是soul-admin产生的,也就是soul-bootstrap启动后与admin建立了连接</p>\n<p>这个时候访问 <a href=\"http://localhost:9195/\" target=\"_blank\" rel=\"external\">http://localhost:9195/</a> 也就是soul-bootstrap会返回</p>\n<pre><code class=\"json\">{\n code: -107,\n message: &quot;Can not find selector, please check your configuration!&quot;,\n data: null\n}\n</code></pre>\n<p>bootstrap产生log</p>\n<pre><code class=\"bash\">2021-01-15 00:20:00.542 ERROR 93827 --- [-work-threads-2] o.d.soul.plugin.base.utils.CheckUtils    : can not match selector data: divide\n</code></pre>\n<p>根据提示我们打开divide页面, <a href=\"http://localhost:9095/#/plug/divide\" target=\"_blank\" rel=\"external\">http://localhost:9095/#/plug/divide</a></p>\n<p>添加selector</p>\n<p><img src=\"/2021/01/15/soul-gateway-src-code-learning-01/03selector.png\" alt=\"pic\"></p>\n<p><img src=\"/2021/01/15/soul-gateway-src-code-learning-01/030_opt.jpg\" alt=\"pic\"></p>\n<blockquote>\n<p>添加selector中我发现 protocol 和 ip:port 会拼接成我们的代理目标地址, 也就是说https<strong>://</strong> 这部分也是要手动写的,这是可以优化的点, 做成可选项的 schema, ip, 和port可选缺省 80, 这样可以更规范配置,另外如上图所示这样的写法也是可以正常被代理到 <a href=\"http://baidu.com\" target=\"_blank\" rel=\"external\">http://baidu.com</a> 的</p>\n</blockquote>\n<p>添加rule</p>\n<p><img src=\"/2021/01/15/soul-gateway-src-code-learning-01/04rule.png\" alt=\"pic\"></p>\n<pre><code class=\"bash\">$curl -i localhost:9195\nHTTP/1.1 302 Found\nContent-Length: 161\nConnection: keep-alive\nContent-Type: text/html\nDate: Thu, 14 Jan 2021 16:29:38 GMT\nKeep-Alive: timeout=4\nLocation: http://www.baidu.com/\nProxy-Connection: keep-alive\nServer: bfe/1.0.8.18\n\n&lt;html&gt;\n&lt;head&gt;&lt;title&gt;302 Found&lt;/title&gt;&lt;/head&gt;\n&lt;body bgcolor=&quot;white&quot;&gt;\n&lt;center&gt;&lt;h1&gt;302 Found&lt;/h1&gt;&lt;/center&gt;\n&lt;hr&gt;&lt;center&gt;bfe/1.0.8.18&lt;/center&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre>\n<p>可以看到我们访问刚配置好的根路径 / path 已经得到重定向返回结果, 浏览器会重定向到https的百度</p>\n<p>至此, 最基本的soul gateway已经跑起来了</p>\n","categories":[],"tags":[{"name":"SOUL","path":"api/tags/SOUL.json"}]}